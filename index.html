<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>千神万王：因果螺旋</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="script/characters.js"></script>
    <script src="script/scenario.js"></script>
    <script src="script/engine.js"></script>
    <script src="script/performance_test.js"></script>
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="icon" href="assets/icon/icon.svg" />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&family=ZCOOL+XiaoWei&family=Ma+Shan+Zheng&display=swap"
      rel="stylesheet"
    />
    <script type="speculationrules">
      {
        "prerender": [
          { "where": { "href_matches": "/*" }, "eagerness": "moderate" }
        ],
        "prefetch": [
          { "where": { "href_matches": "/*" }, "eagerness": "moderate" }
        ]
      }
    </script>
    <script>
      // 检测不支持 speculationrules 的浏览器
      if (
        !HTMLScriptElement.supports ||
        !HTMLScriptElement.supports("speculationrules")
      ) {
        const preloadedUrls = {};

        function pointerenterHandler() {
          if (!preloadedUrls[this.href]) {
            preloadedUrls[this.href] = true;

            const prefetcher = document.createElement("link"); // 判断是支持 prefetch 还是只能用普通的 fetch
            prefetcher.as = prefetcher.relList.supports("prefetch")
              ? "document"
              : "fetch";
            prefetcher.rel = prefetcher.relList.supports("prefetch")
              ? "prefetch"
              : "preload";
            prefetcher.href = this.href;

            document.head.appendChild(prefetcher);
          }
        } // 给所有内部链接绑定鼠标悬停事件

        document.querySelectorAll('a[href^="/"]').forEach((item) => {
          item.addEventListener("pointerenter", pointerenterHandler);
        });
      }
    </script>
  </head>

  <body>
    <!-- 免责声明 -->
    <div id="disclaimer-layer">
      <div class="disclaimer-container">
        <div class="disclaimer-title">游戏前详阅</div>
        <div class="disclaimer-content">
          <p>本网站为《千神万王：因果螺旋》游戏。</p>
          <p>
            本游戏包含虚构内容，所有角色、情节均为艺术创作，与现实人物、事件无关，如有雷同，纯属巧合。
          </p>
          <p>
            游戏过程中可能包含闪烁画面等内容，请根据自身情况酌情体验。在体验游戏过程中，若感到不适，请立即停止游戏，并征求专业医疗建议。
          </p>
        </div>
        <div class="disclaimer-btn" onclick="acceptDisclaimer()">
          我已阅读, 进入游戏
        </div>
      </div>
      <div class="disclaimer-overlay"></div>
    </div>

    <div id="stage">
      <div class="noise"></div>
      <div id="bg-layer" class="pan-anim"></div>
      <div class="cinematic-overlay"></div>

      <!-- 主菜单 -->
      <div id="menu-screen">
        <div class="title-block">
          <div class="main-logo">千神万王</div>
          <div class="sub-logo">The Spiral of Causality</div>
        </div>
        <div class="menu-nav">
          <div class="nav-link" onclick="game.start()">新游戏 · NEW GAME</div>
          <div class="nav-link" onclick="game.load()">继续观测 · CONTINUE</div>
          <div
            class="nav-link"
            onclick="window.location.href = 'chapters.html'"
          >
            章节回看 · CHAPTERS
          </div>
          <div
            class="nav-link"
            onclick="
              window.open(
                'https://github.com/haitang000/qianshenwanwang',
                '_blank',
              )
            "
          >
            前往 GitHub 仓库赤石
          </div>
        </div>
      </div>

      <!-- 游戏层 -->
      <div id="game-screen" onclick="game.clickScreen(event)">
        <!-- 立绘容器 -->
        <div id="char-container"></div>

        <!-- 对话框 -->
        <div class="dialog-bar" id="dialog-box">
          <div id="ui-name" class="speaker-name"></div>
          <div id="ui-text" class="dialog-text"></div>

          <div class="mini-controls">
            <div class="ctrl-btn" onclick="game.save(event)">SAVE</div>
            <div class="ctrl-btn" onclick="game.load()">LOAD</div>
            <div class="ctrl-btn" onclick="game.death()">SKIP</div>
            <div class="ctrl-btn" onclick="location.reload()">TITLE</div>
            <div class="ctrl-btn" onclick="toggleMusicMute()" id="music-btn">
              ♪
            </div>
          </div>
        </div>
      </div>

      <div id="choice-layer"></div>

      <!-- 加载进度条 -->
      <div id="loading-layer">
        <div class="loading-vignette"></div>
        <div class="loading-scanlines"></div>

        <div class="loading-container">
          <div class="loading-header">
            <div class="loading-brand">
              <span class="brand-main">CAUSALITY</span>
              <span class="brand-sub">OBSERVATION SYSTEM v2.0</span>
            </div>
            <div class="loading-status">
              STATUS: <span class="status-active">ACTIVE</span>
            </div>
          </div>

          <div class="loading-main">
            <div class="loading-circle-wrap">
              <svg class="loading-circle-svg" viewBox="0 0 100 100">
                <circle class="circle-bg" cx="50" cy="50" r="45"></circle>
                <circle class="circle-progress" cx="50" cy="50" r="45"></circle>
              </svg>
              <div class="loading-percentage">0%</div>
            </div>
            <div class="loading-info">
              <div class="loading-text">正在初始化观测协议...</div>
              <div class="loading-bar">
                <div class="loading-progress"></div>
              </div>
            </div>
          </div>

          <div class="loading-footer">
            <div class="loading-tips">
              系统提示：每一条因果线的选择都将指向不可逃避的终焉。
            </div>
            <div class="loading-decorator"></div>
          </div>
        </div>

        <div class="loading-corners">
          <div class="corner tl"></div>
          <div class="corner tr"></div>
          <div class="corner bl"></div>
          <div class="corner br"></div>
        </div>
      </div>

      <!-- 难度选择页面 -->
      <div id="difficulty-layer">
        <div class="difficulty-header">
          <div class="difficulty-back" onclick="game.backToMenu()">← 返回</div>
          <div class="difficulty-title">选择观测难度</div>
          <div class="difficulty-subtitle">SELECT OBSERVATION DIFFICULTY</div>
        </div>
        <div class="difficulty-grid">
          <div class="difficulty-card" onclick="game.selectDifficulty('easy')">
            <div class="difficulty-icon">◈</div>
            <div class="difficulty-name">简单</div>
            <div class="difficulty-en">CASUAL</div>
            <div class="difficulty-desc">轻松体验剧情，无压力</div>
            <div class="difficulty-meta">推荐：故事向玩家</div>
          </div>
          <div class="difficulty-card" onclick="game.selectDifficulty('medium')">
            <div class="difficulty-icon">◉</div>
            <div class="difficulty-name">中等</div>
            <div class="difficulty-en">STANDARD</div>
            <div class="difficulty-desc">平衡的探索与挑战体验</div>
            <div class="difficulty-meta">推荐：普通玩家</div>
          </div>
          <div class="difficulty-card" onclick="game.selectDifficulty('hard')">
            <div class="difficulty-icon">✦</div>
            <div class="difficulty-name">困难</div>
            <div class="difficulty-en">HARDCORE</div>
            <div class="difficulty-desc">每一次选择都至关重要</div>
            <div class="difficulty-meta">推荐：追求挑战的玩家</div>
          </div>
          <div class="difficulty-card porcelain" onclick="game.selectDifficulty('porcelain')">
            <div class="difficulty-icon">✺</div>
            <div class="difficulty-name">瓷器</div>
            <div class="difficulty-en">PORCELAIN</div>
            <div class="difficulty-desc">极致的脆弱与美丽</div>
            <div class="difficulty-meta">推荐：？？？</div>
          </div>
        </div>
        <div class="difficulty-hint">※ 难度选择将影响剧情分支与结局走向</div>
      </div>

      <div id="death-layer" onclick="location.reload()">
        <div class="game-over-title">死</div>
        <div class="game-over-subtitle">
          跳过剧情等于跳过生命<br />---我也不知道谁说的别问我
        </div>
      </div>
    </div>

    <script>
      // 免责声明处理
      function acceptDisclaimer() {
        const disclaimer = document.getElementById("disclaimer-layer");
        disclaimer.classList.add("disclaimer-hidden");

        // 标记已阅读
        localStorage.setItem("disclaimer_accepted", "true");

        // 播放主菜单音乐（用户交互后播放，避免浏览器自动播放限制）
        if (window.game && window.game.musicManager) {
          window.game.musicManager.play('entrance', { fadeDuration: 2000, loop: true });
        }

        // 动画结束后移除元素
        setTimeout(() => {
          disclaimer.style.display = "none";
        }, 800);
      }

      // 页面加载时检查是否已经阅读过免责声明
      document.addEventListener("DOMContentLoaded", function () {
        if (localStorage.getItem("disclaimer_accepted") === "true") {
          const disclaimer = document.getElementById("disclaimer-layer");
          if (disclaimer) {
            disclaimer.style.display = "none";
          }
          // 已阅读过，延迟播放音乐（确保引擎已初始化）
          setTimeout(() => {
            if (window.game && window.game.musicManager) {
              window.game.musicManager.play('entrance', { fadeDuration: 2000, loop: true });
            }
          }, 100);
        }
      });

      // 支持按回车键确认
      document.addEventListener("keydown", function (e) {
        const disclaimer = document.getElementById("disclaimer-layer");
        if (
          e.key === "Enter" &&
          disclaimer &&
          disclaimer.style.display !== "none" &&
          !disclaimer.classList.contains("disclaimer-hidden")
        ) {
          acceptDisclaimer();
        }
      });

      // 音乐静音切换
      function toggleMusicMute() {
        if (window.game && window.game.musicManager) {
          const isMuted = window.game.musicManager.toggleMute();
          const btn = document.getElementById("music-btn");
          if (btn) {
            btn.textContent = isMuted ? "♪" : "♪";
            btn.style.opacity = isMuted ? "0.5" : "1";
          }
        }
      }
    </script>
  </body>
</html>
